<% @page_title = 'Учет пациентов - АФО' %>

<div class="app-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-hospital me-2"></i>Учет пациентов</h1>
                <p>Акушерское физиологическое отделение</p>
            </div>
            <div>
                <a href="/upload" class="btn btn-light me-2">
                    <i class="bi bi-upload me-1"></i>Загрузить Excel
                </a>
                <a href="/export" class="btn btn-outline-light">
                    <i class="bi bi-download me-1"></i>Выгрузить
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <% if params[:success] %>
        <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
            <i class="bi bi-check-circle me-2"></i>Данные успешно импортированы!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% end %>

    <div class="row mb-3">
        <div class="col-md-8">
            <div class="control-panel">
                <form method="get" action="/" class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Отделение</label>
                        <select name="department" class="form-select">
                            <% @departments.each do |dept| %>
                                <option value="<%= dept[:short] %>" 
                                        <%= 'selected' if @selected_department == dept[:short] %>>
                                    <%= dept[:short] %> - <%= dept[:full] %>
                                </option>
                            <% end %>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Дата</label>
                        <input type="date" name="date" value="<%= @selected_date %>" class="form-control">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-purple w-100">
                            <i class="bi bi-search me-1"></i>Показать
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number"><%= @patients.count %></div>
                <div class="text-muted">пациентов</div>
            </div>
        </div>
    </div>

    <div class="patient-table">
        <div class="table-header">
            <h4>Пациенты</h4>
            <button class="btn btn-success" onclick="addPatient()">
                <i class="bi bi-plus-circle me-1"></i>Добавить пациента
            </button>
        </div>
        
        <div class="p-3 border-bottom">
            <div class="search-box">
                <input type="text" id="searchInput" class="form-control" placeholder="Поиск по ФИО, палате, датам...">
                <div class="form-text mt-1 text-smaller">
                    Поиск осуществляется по всем полям таблицы в реальном времени
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="60">Палата</th>
                        <th>ФИО пациента</th>
                        <th width="100">Дата рождения</th>
                        <th width="100">Дата родов</th>
                        <th width="100">Где ребёнок</th>
                        <th width="40" class="text-center">У</th>
                        <th width="40" class="text-center">О</th>
                        <th width="40" class="text-center">В</th>
                        <th width="60">Стол</th>
                        <th width="80" class="foreigner-cell">Иногородний</th>
                        <th width="150">Примечания</th>
                        <th width="70" class="text-center">Действия</th>
                    </tr>
                </thead>
                <tbody id="patientsTable">
                    <% if @patients.empty? %>
                        <tr>
                            <td colspan="12" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox fs-1"></i>
                                    <p class="mt-2">Нет данных для отображения</p>
                                    <p class="small">Загрузите данные из Excel или добавьте пациента вручную</p>
                                </div>
                            </td>
                        </tr>
                    <% else %>
                        <% @patients.each do |patient| %>
                            <tr id="patient-<%= patient.id %>" data-patient-id="<%= patient.id %>" class="patient-row">
                                <td class="editable" data-field="room_number">
                                    <span class="cell-content">
                                        <%= patient.room_number.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="full_name">
                                    <span class="cell-content">
                                        <%= patient.full_name.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="birth_date">
                                    <span class="cell-content">
                                        <%= patient.birth_date.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="birth_date_of_child">
                                    <span class="cell-content">
                                        <%= patient.birth_date_of_child.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="child_location">
                                    <span class="cell-content">
                                        <%= patient.child_location.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable thermometry-cell" data-field="thermometry_u">
                                    <span class="cell-content">
                                        <%= patient.thermometry_u.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable thermometry-cell" data-field="thermometry_o">
                                    <span class="cell-content">
                                        <%= patient.thermometry_o.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable thermometry-cell" data-field="thermometry_v">
                                    <span class="cell-content">
                                        <%= patient.thermometry_v.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="table_number">
                                    <span class="cell-content">
                                        <%= patient.table_number.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable foreigner-cell" data-field="is_foreigner">
                                    <span class="cell-content">
                                        <%= patient.is_foreigner.presence || '—' %>
                                    </span>
                                </td>
                                <td class="editable" data-field="notes">
                                    <span class="cell-content">
                                        <%= patient.notes.presence || '—' %>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger action-btn" 
                                            onclick="deletePatient(<%= patient.id %>, '<%= patient.full_name %>')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% end %>
                    <% end %>
                </tbody>
            </table>
            <div id="noResults" class="no-results" style="display: none;">
                <i class="bi bi-search fs-3"></i>
                <p class="mt-2">Ничего не найдено</p>
                <p class="small">Попробуйте изменить поисковый запрос</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления пациента -->
<div class="modal fade" id="addPatientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить пациента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPatientForm">
                    <div class="mb-3">
                        <label class="form-label">Палата</label>
                        <input type="text" name="room_number" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ФИО пациента</label>
                        <input type="text" name="full_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата рождения</label>
                        <input type="date" name="birth_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата родов</label>
                        <input type="date" name="birth_date_of_child" class="form-control" required>
                    </div>
                    <input type="hidden" name="department" value="<%= @selected_department %>">
                    <input type="hidden" name="registration_date" value="<%= @selected_date %>">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveNewPatient()">Сохранить</button>
            </div>
        </div>
    </div>
</div>