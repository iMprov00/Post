<% @page_title = 'Учет пациентов - АФО' %>

<div class="app-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-hospital me-2"></i>Учет пациентов</h1>
                <p>Акушерское физиологическое отделение</p>
            </div>
            <div>
                <a href="/upload" class="btn btn-light me-2">
                    <i class="bi bi-upload me-1"></i>Загрузить Excel
                </a>
                <a href="/export" class="btn btn-outline-light">
                    <i class="bi bi-download me-1"></i>Выгрузить
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <% if params[:success] %>
        <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
            <i class="bi bi-check-circle me-2"></i>Данные успешно импортированы!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% end %>

    <!-- index.erb - добавить после строки с датой в control-panel -->
    <div class="row mb-3">
      <div class="col-md-8">
        <div class="control-panel">
          <form method="get" action="/" class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Отделение</label>
              <select name="department" class="form-select">
                <% @departments.each do |dept| %>
                  <option value="<%= dept[:short] %>" 
                          <%= 'selected' if @selected_department == dept[:short] %>>
                    <%= dept[:short] %> - <%= dept[:full] %>
                  </option>
                <% end %>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Дата</label>
              <input type="date" name="date" value="<%= @selected_date %>" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Палата</label>
              <select name="room" class="form-select" id="roomFilter">
                <option value="">Все палаты</option>
                <% if @patients.any? %>
                  <% @rooms.each do |room| %>
                    <option value="<%= room %>" <%= 'selected' if params[:room] == room %>>
                      Палата <%= room %>
                    </option>
                  <% end %>
                <% end %>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button type="submit" class="btn btn-purple w-100">
                <i class="bi bi-search me-1"></i>Показать
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card">
          <div class="stats-number"><%= @patients.count %></div>
          <div class="text-muted">пациентов</div>
        </div>
      </div>
    </div>

    <!-- index.erb - замените блок таблицы -->
<!-- index.erb - замените блок таблицы на этот код -->
<div class="patient-table">
  <div class="table-header">
    <h4>Пациенты</h4>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="toggleAllRooms()">
        <i class="bi bi-chevron-double-up"></i> Свернуть все
      </button>
      <button class="btn btn-success" onclick="addPatient()">
        <i class="bi bi-plus-circle me-1"></i>Добавить пациента
      </button>
    </div>
  </div>
  
  <div class="p-3 border-bottom">
    <div class="search-box">
      <input type="text" id="searchInput" class="form-control" placeholder="Поиск по ФИО, палате, датам...">
      <div class="form-text mt-1 text-smaller">
        Поиск осуществляется по всем полям таблицы в реальном времени
      </div>
    </div>
  </div>
  
  <div class="table-container" id="patientsContainer">
    <% if @patients.empty? %>
      <div class="text-center py-4">
        <div class="text-muted">
          <i class="bi bi-inbox fs-1"></i>
          <p class="mt-2">Нет данных для отображения</p>
          <p class="small">Загрузите данные из Excel или добавьте пациента вручную</p>
        </div>
      </div>
    <% else %>
      <% @patients.group_by(&:room_number).each do |room_number, room_patients| %>
        <div class="room-section <%= 'no-room-section' if room_number.blank? %>" 
             data-room="<%= room_number %>"
             id="room-<%= room_number.to_s.parameterize %>">
          
          <!-- Заголовок палаты -->
          <div class="room-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="room-title">
                <i class="bi bi-door-closed me-2"></i>
                <strong>Палата <%= room_number.presence || 'Без палаты' %></strong>
                <span class="patient-count ms-3"><%= room_patients.count %> пациент(ов)</span>
              </div>
              <div class="room-actions">
                <button class="btn btn-sm room-toggle" onclick="toggleRoom(this, '<%= room_number %>')">
                  <i class="bi bi-chevron-up"></i> Свернуть
                </button>
              </div>
            </div>
          </div>
          
          <!-- Таблица пациентов в палате -->
          <div class="room-patients">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th width="60">Палата</th>
                  <th>ФИО пациента</th>
                  <th width="100">Дата рождения</th>
                  <th width="100">Дата родов</th>
                  <th width="100">Где ребёнок</th>
                  <th width="40" class="text-center">У</th>
                  <th width="40" class="text-center">О</th>
                  <th width="40" class="text-center">В</th>
                  <th width="60">Стол</th>
                  <th width="80" class="foreigner-cell">Иногородний</th>
                  <th width="80" class="contract-cell">Контракт</th>
                  <th width="150">Примечания</th>
                  <th width="70" class="text-center">Действия</th>
                </tr>
              </thead>
              <tbody>
                <% room_patients.each do |patient| %>
                  <tr id="patient-<%= patient.id %>" 
                      data-patient-id="<%= patient.id %>" 
                      class="patient-row"
                      data-room="<%= patient.room_number %>">
                    <td class="editable" data-field="room_number">
                      <span class="cell-content">
                        <%= patient.room_number.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable" data-field="full_name">
                      <span class="cell-content">
                        <%= patient.full_name.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable" data-field="birth_date">
                      <span class="cell-content">
                        <%= patient.birth_date.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable" data-field="birth_date_of_child">
                      <span class="cell-content">
                        <%= patient.birth_date_of_child.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable" data-field="child_location">
                      <span class="cell-content">
                        <%= patient.child_location.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable thermometry-cell" data-field="thermometry_u">
                      <span class="cell-content">
                        <%= patient.thermometry_u.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable thermometry-cell" data-field="thermometry_o">
                      <span class="cell-content">
                        <%= patient.thermometry_o.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable thermometry-cell" data-field="thermometry_v">
                      <span class="cell-content">
                        <%= patient.thermometry_v.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable" data-field="table_number">
                      <span class="cell-content">
                        <%= patient.table_number.presence || '—' %>
                      </span>
                    </td>
                    <td class="editable foreigner-cell" data-field="is_foreigner">
                      <span class="cell-content" data-search-text="иногородний <%= patient.is_foreigner == 'да' ? 'да' : 'нет' %>">
                        <% if patient.is_foreigner == 'да' %>
                          <i class="bi bi-check-square"></i>
                        <% else %>
                          <i class="bi bi-square"></i>
                        <% end %>
                      </span>
                    </td>
                    <td class="editable contract-cell" data-field="contract">
                      <span class="cell-content" data-search-text="контракт <%= patient.contract ? 'да' : 'нет' %>">
                        <% if patient.contract %>
                          <i class="bi bi-check-square"></i>
                        <% else %>
                          <i class="bi bi-square"></i>
                        <% end %>
                      </span>
                    </td>
                    <td class="editable" data-field="notes">
                      <span class="cell-content">
                        <%= patient.notes.presence || '—' %>
                      </span>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-danger action-btn" 
                              onclick="deletePatient(<%= patient.id %>, '<%= patient.full_name %>')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
  
  <div id="noResults" class="no-results" style="display: none;">
    <i class="bi bi-search fs-3"></i>
    <p class="mt-2">Ничего не найдено</p>
    <p class="small">Попробуйте изменить поисковый запрос или выбрать другую палату</p>
  </div>
</div>
</div>

<!-- Модальное окно для добавления пациента -->
<div class="modal fade" id="addPatientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить пациента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                <div class="modal-body">
                  <form id="addPatientForm">
                    <div class="mb-3">
                      <label class="form-label">Палата</label>
                      <input type="text" name="room_number" class="form-control" list="roomOptions" autocomplete="off">
                      <datalist id="roomOptions">
                        <option value="1">
                        <option value="2">
                        <option value="3">
                        <option value="4">
                        <option value="VIP">
                      </datalist>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ФИО пациента</label>
                      <input type="text" name="full_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Дата рождения</label>
                      <input type="date" name="birth_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Дата родов</label>
                      <input type="date" name="birth_date_of_child" class="form-control" required>
                    </div>
                    <!-- Добавляем поля со значениями по умолчанию -->
                    <div class="mb-3">
                      <label class="form-label">Где ребёнок</label>
                      <input type="text" name="child_location" class="form-control" value="+" list="childLocationOptions" autocomplete="off">
                      <datalist id="childLocationOptions">
                        <option value="+">
                        <option value="ДРО">
                        <option value="ДО">
                      </datalist>
                    </div>
                    <div class="row mb-3">
                      <div class="col">
                        <label class="form-label">Температура У</label>
                        <input type="text" name="thermometry_u" class="form-control" value="36,6">
                      </div>
                      <div class="col">
                        <label class="form-label">Температура О</label>
                        <input type="text" name="thermometry_o" class="form-control" value="36,6">
                      </div>
                      <div class="col">
                        <label class="form-label">Температура В</label>
                        <input type="text" name="thermometry_v" class="form-control" value="36,6">
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Стол</label>
                      <input type="text" name="table_number" class="form-control" list="tableOptions" autocomplete="off">
                      <datalist id="tableOptions">
                        <option value="1">
                        <option value="2">
                      </datalist>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Примечания</label>
                      <input type="text" name="notes" class="form-control" list="notesOptions" autocomplete="off">
                      <datalist id="notesOptions">
                        <option value="ХАГ">
                        <option value="ГАГ">
                        <option value="эпизио">
                      </datalist>
                    </div>
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_foreigner" id="isForeignerCheck">
                        <label class="form-check-label" for="isForeignerCheck">
                          Иногородний
                        </label>
                      </div>
                    </div>
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="contract" id="contractCheck">
                        <label class="form-check-label" for="contractCheck">
                          Контракт
                        </label>
                      </div>
                    </div>
                    <input type="hidden" name="department" value="<%= @selected_department %>">
                    <input type="hidden" name="registration_date" value="<%= @selected_date %>">
                  </form>
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveNewPatient()">Сохранить</button>
            </div>
        </div>
    </div>
</div>